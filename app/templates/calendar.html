<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassFinder - Create Calendar</title>
    <link rel="stylesheet" href="/index.css">
</head>
<body>
    {% include 'header.html' %}
    <main>
        <h1>Create Calendar</h1>
        <div id="calform">
            <div id="options">
                <label for="showpassing">Add passing periods</label>
                <input type="checkbox" id="showpassing" name="showpassing">
                <label for="showdaytype">Add day type</label>
                <input type="checkbox" id="showdaytype" name="showdaytype" checked>
            </div>
            <button id="generate" onclick="genCalLink(event)">Generate Calendar Link</button>
            <button id="download" onclick="downloadCal(event)">Download Calendar</button>
        </div>
        <div class="loader" id="spinner" style="display:none;"></div>
        <p id="cal-link"></p>
        <script>
            function genCalLink(event) {
                event.preventDefault();
                document.getElementById('calform').style.display = 'none';
                document.getElementById('spinner').style.display = 'block';
                fetch('/api/v2/createscopedtoken', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        scopes: ['read-classes']
                    })
                })
                .then(response => response.json())
                .then(token => {
                    const showPassing = document.getElementById('showpassing').checked;
                    const showDayType = document.getElementById('showdaytype').checked;
                    
                    const params = new URLSearchParams();
                    if (showPassing) params.append('passing', '');
                    if (showDayType) params.append('adddaytype', '');

                    const calLink = `${window.location.origin}/${token}/calendar.ics${params.toString() ? '?' + params.toString() : ''}`;
                    
                    document.getElementById('cal-link').textContent = 'Calendar URL: ' + calLink;
                    document.getElementById('spinner').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error creating token:', error);
                    document.getElementById('cal-link').textContent = 'Error creating link: ' + error.message;
                    document.getElementById('spinner').style.display = 'none';
                });
            }
            function downloadCal(event) {
                event.preventDefault();
                
                const showPassing = document.getElementById('showpassing').checked;
                const showDayType = document.getElementById('showdaytype').checked;
                
                const params = new URLSearchParams();
                if (showPassing) params.append('passing', 'true');
                if (showDayType) params.append('adddaytype', 'true');

                // Technically "download" is not a token, but the server defaults to using cookies if this is invalid
                // and if you reached this page, you are logged in, so this is safe
                const calLink = `${window.location.origin}/download/calendar.ics${params.toString() ? '?' + params.toString() : ''}`;
                
                window.open(calLink, '_blank');
            }
        </script>
    </main>
</body>
</html>